
#include <string.h>
#include <SDL.h>
#include "blitter.h"

typedef uint8_t byte;

/* (R, G, B) ... */
static const byte default_palette[192] = {
	0x65, 0x65, 0x65, 0x03, 0x16, 0x84, 0x09, 0x03, 0xA0, 0x3E, 0x07, 0x94, 0x61, 0x00, 0x63, 0x7A,
	0x00, 0x30, 0x79, 0x05, 0x00, 0x5E, 0x17, 0x00, 0x37, 0x2A, 0x00, 0x0E, 0x39, 0x00, 0x00, 0x4C,
	0x03, 0x00, 0x43, 0x1D, 0x02, 0x35, 0x5B, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	0xB7, 0xB7, 0xB7, 0x09, 0x5B, 0xDD, 0x2C, 0x30, 0xF7, 0x7A, 0x11, 0xEB, 0xAD, 0x07, 0xC4, 0xC7,
	0x09, 0x6D, 0xC8, 0x21, 0x0B, 0xA8, 0x47, 0x09, 0x72, 0x63, 0x00, 0x2A, 0x7B, 0x00, 0x01, 0x89,
	0x01, 0x00, 0x84, 0x46, 0x00, 0x78, 0x92, 0x0C, 0x0C, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
	0xFB, 0xFB, 0xFB, 0x4B, 0xAB, 0xFE, 0x79, 0x83, 0xFC, 0xB0, 0x73, 0xFE, 0xEB, 0x54, 0xFD, 0xF9,
	0x69, 0xC1, 0xFB, 0x79, 0x5C, 0xEB, 0x98, 0x2A, 0xCD, 0xBC, 0x11, 0x80, 0xCF, 0x0C, 0x3E, 0xDE,
	0x2D, 0x33, 0xDC, 0x8A, 0x24, 0xD1, 0xD5, 0x53, 0x53, 0x53, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
	0xFE, 0xFE, 0xFE, 0xB1, 0xDE, 0xFE, 0xC8, 0xC8, 0xFE, 0xDF, 0xBC, 0xFC, 0xF5, 0xB4, 0xFE, 0xFD,
	0xBE, 0xE0, 0xFE, 0xCA, 0xB7, 0xFC, 0xDB, 0x97, 0xF3, 0xE9, 0x8E, 0xD3, 0xF0, 0x8F, 0xAF, 0xF7,
	0xA3, 0xA1, 0xF2, 0xD1, 0xA2, 0xED, 0xF4, 0xBA, 0xBA, 0xBA, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05,
};

/* 0xARGB (little endian) */
static uint32_t palette[64 * 8];

#define MAKE_ARGB(a, r, g, b)\
        ((((uint32_t)(a)) << 24)|\
        (((uint32_t)(r)) << 16)|\
        (((uint32_t)(g)) << 8)|\
        ((uint32_t)(b)))

#define ARGB_A(c) (((c) >> 24) & 0xff)
#define ARGB_R(c) (((c) >> 16) & 0xff)
#define ARGB_G(c) (((c) >> 8) & 0xff)
#define ARGB_B(c) ((c) & 0xff)

/* from NinTech.txt (R, G, B) */
static const double empfactor[8][3] = {
	{ 1.0, 1.0, 1.0 },          /*000     */
	{ 1.239, 0.915, 0.743 },    /*001 r   */
	{ 0.794, 1.086, 0.882 },    /*010 g   */
	{ 1.019, 0.980, 0.653 },    /*011 rg  */
	{ 0.905, 1.026, 1.277 },    /*100 b   */
	{ 1.023, .908, 0.979 },     /*101 rb  */
	{ 0.741, 0.987, 1.001 },    /*110 gb  */
	{ 0.75, 0.75, 0.75 }        /*111 rgb */
};

static uint32_t emp_color(uint32_t col, const double *emp)
{
	double r = (ARGB_R(col) / 255.0) * emp[0];
	double g = (ARGB_G(col) / 255.0) * emp[1];
	double b = (ARGB_B(col) / 255.0) * emp[2];
	if (r > 1.0) {
		r = 1.0;
	}
	if (g > 1.0) {
		g = 1.0;
	}
	if (b > 1.0) {
		b = 1.0;
	}
	return MAKE_ARGB(ARGB_A(col),
	                 ((byte)(r * 255.0)), ((byte)(g * 255.0)), ((byte)(b * 255.0)));
}

void blitter_init(void)
{
	/* pixel format: emphasis[blue:1 green:1 red:1] palette_index:6 */
	int i, j, c;
	for (j = 0; j < 8; ++j) {
		if (!j) {
			/* base palette, just copy */
			for (i = 0; i < 64; ++i) {
				c = i * 3;
				palette[i] = MAKE_ARGB(0xff, default_palette[c],
				                       default_palette[c + 1], default_palette[c + 2]);
			}
		} else {
			/* generate emphasis palette */
			uint32_t *emp_pal = palette + j * 64;
			for (i = 0; i < 64; ++i) {
				emp_pal[i] = emp_color(palette[i], empfactor[j]);
			}
		}
	}
}

void blitter_blit(SDL_Texture *texture, const uint16_t *frame)
{
	uint32_t *image, *dst;
	int pitch, index = 0;
	if (0 == SDL_LockTexture(texture, NULL, (void**) &image, &pitch)) {
		int x, y;
		for (y = 0; y < 240; ++y) {
			dst = image + y * (pitch / 4);
			for (x = 0; x < 256; ++x) {
				*dst++ = *(palette + *(frame + index++));
			}
		}
		SDL_UnlockTexture(texture);
	}
}
